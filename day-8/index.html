<!DOCTYPE HTML>
<html lang="pt" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Descomplicando o Prometheus</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/css/style.css">
        <link rel="stylesheet" href="../theme/css/mdbook-admonish.css">

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introdução</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="../BOOKSUMMARY.html">Sumário</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Capítulos</li><li class="chapter-item expanded "><a href="../day-1/index.html"><strong aria-hidden="true">1.</strong> Dia 1</a></li><li class="chapter-item expanded "><a href="../day-2/index.html"><strong aria-hidden="true">2.</strong> Dia 2</a></li><li class="chapter-item expanded "><a href="../day-3/index.html"><strong aria-hidden="true">3.</strong> Dia 3</a></li><li class="chapter-item expanded "><a href="../day-4/index.html"><strong aria-hidden="true">4.</strong> Dia 4</a></li><li class="chapter-item expanded "><a href="../day-5/index.html"><strong aria-hidden="true">5.</strong> Dia 5</a></li><li class="chapter-item expanded "><a href="../day-6/index.html"><strong aria-hidden="true">6.</strong> Dia 6</a></li><li class="chapter-item expanded "><a href="../day-7/index.html"><strong aria-hidden="true">7.</strong> Dia 7</a></li><li class="chapter-item expanded "><a href="../day-8/index.html" class="active"><strong aria-hidden="true">8.</strong> Dia 8</a></li><li class="chapter-item expanded "><a href="../day-9/index.html"><strong aria-hidden="true">9.</strong> Dia 9</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Descomplicando o Prometheus</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/badtuxx/DescomplicandoPrometheus" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/badtuxx/DescomplicandoPrometheus/edit/main/pt/src/day-8/README.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <!-- Page table of contents -->
                        <div class="sidetoc"><nav class="pagetoc"></nav></div>

                        <h1 id="descomplicando-o-prometheus"><a class="header" href="#descomplicando-o-prometheus">Descomplicando o Prometheus</a></h1>
<h2 id="day-8"><a class="header" href="#day-8">DAY-8</a></h2>
<h3 id="o-que-iremos-ver-hoje"><a class="header" href="#o-que-iremos-ver-hoje">O que iremos ver hoje?</a></h3>
<p>Durante o dia de hoje, nós iremos passear um pouco pelas métricas que estamos coletando do nosso cluster Kubernetes. A ideia hoje é brincar um pouco mais com PromQL para extrair o máximo de valor das métricas que estamos coletando.</p>
<p>Quando estamos utilizando o Kube-Prometheus, temos que saber que já temos dezenas de novas métricas que nos mostram detalhes do comportamento do nosso cluster.</p>
<p>Outro ponto importante do dia de hoje será conhecer um pouco mais no detalhe, onde e como podemos mudar as características do nosso Prometheus e do nosso AlertManager.</p>
<p>Quando instalamos o Kube-Prometheus, e por consequência o Prometheus Operator, nós estamos expandindo o Kubernetes, dando maiores poderes e funções que antes ele não tinha. Entre os novos poderes que o Kubernetes agora possui estão os recursos que já vimos, como o PodMonitor, ServiceMonitor e o PrometheusRule.</p>
<p>Hoje ainda iremos conhecer mais dois recursos que o Prometheus Operator nos dá, um recurso chamado Prometheus e outro chamado AlertManager. Mas não vou dar detalhes agora, somente durante o dia de hoje.</p>
<h3 id="conteúdo-do-day-8"><a class="header" href="#conteúdo-do-day-8">Conteúdo do Day-8</a></h3>
<details>
<summary class="summary">DAY-8</summary>
<ul>
<li><a href="#descomplicando-o-prometheus">Descomplicando o Prometheus</a>
<ul>
<li><a href="#day-8">DAY-8</a>
<ul>
<li><a href="#o-que-iremos-ver-hoje">O que iremos ver hoje?</a></li>
<li><a href="#conte%C3%BAdo-do-day-8">Conteúdo do Day-8</a>
<ul>
<li><a href="#vamos-brincar-com-as-m%C3%A9tricas-do-kubernetes">Vamos brincar com as métricas do Kubernetes</a>
<ul>
<li><a href="#o-que-podemos-saber-sobre-os-nodes-do-nosso-cluster">O que podemos saber sobre os nodes do nosso cluster?</a>
<ul>
<li><a href="#quantos-n%C3%B3s-temos-no-nosso-cluster">Quantos nós temos no nosso cluster?</a></li>
<li><a href="#qual-a-quantidade-de-cpu-e-mem%C3%B3ria-que-cada-n%C3%B3-tem">Qual a quantidade de CPU e memória que cada nó tem?</a></li>
<li><a href="#o-n%C3%B3-est%C3%A1-dispon%C3%ADvel-para-receber-novos-pods">O nó está disponível para receber novos pods?</a></li>
<li><a href="#qual-a-quantidade-de-informa%C3%A7%C3%A3o-que-cada-n%C3%B3-est%C3%A1-recebendo-e-enviando">Qual a quantidade de informação que cada nó está recebendo e enviando?</a></li>
</ul>
</li>
<li><a href="#quantos-pods-est%C3%A3o-rodando-em-cada-n%C3%B3">Quantos pods estão rodando em cada nó?</a></li>
</ul>
</li>
<li><a href="#agora-vamos-saber-se-o-nosso-cluster-est%C3%A1-com-problemas">Agora vamos saber se o nosso cluster está com problemas</a>
<ul>
<li><a href="#o-que-podemos-saber-sobre-os-pods-do-nosso-cluster">O que podemos saber sobre os pods do nosso cluster?</a>
<ul>
<li><a href="#quantos-pods-est%C3%A3o-rodando-no-nosso-cluster">Quantos pods estão rodando no nosso cluster?</a></li>
<li><a href="#quantos-pods-est%C3%A3o-com-problemas">Quantos pods estão com problemas?</a></li>
<li><a href="#verificar-os-pods-e-os-limites-de-mem%C3%B3ria-e-cpu-configurados">Verificar os pods e os limites de memória e CPU configurados</a></li>
<li><a href="#verificar-se-o-cluster-est%C3%A1-com-problemas-relacionados-ao-disco">Verificar se o cluster está com problemas relacionados ao disco</a></li>
<li><a href="#verificar-se-o-cluster-est%C3%A1-com-problemas-relacionados-a-mem%C3%B3ria">Verificar se o cluster está com problemas relacionados a memória</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#e-como-saber-se-meus-deployments-est%C3%A3o-com-problemas">E como saber se meus deployments estão com problemas?</a>
<ul>
<li><a href="#quantos-deployments-est%C3%A3o-rodando-no-meu-cluster">Quantos deployments estão rodando no meu cluster?</a></li>
<li><a href="#quantos-deployments-est%C3%A3o-com-problemas">Quantos deployments estão com problemas?</a></li>
<li><a href="#qual-o-status-dos-meus-deployments">Qual o status dos meus deployments?</a></li>
</ul>
</li>
<li><a href="#e-como-saber-se-meus-servi%C3%A7os-est%C3%A3o-com-problemas">E como saber se meus serviços estão com problemas?</a>
<ul>
<li><a href="#quantos-servi%C3%A7os-est%C3%A3o-rodando-no-meu-cluster">Quantos serviços estão rodando no meu cluster?</a></li>
<li><a href="#todos-os-meus-servi%C3%A7os-est%C3%A3o-com-endpoints">Todos os meus serviços estão com endpoints?</a></li>
<li><a href="#todos-os-meus-servi%C3%A7os-est%C3%A3o-com-endpoints-ativos">Todos os meus serviços estão com endpoints ativos?</a></li>
</ul>
</li>
<li><a href="#como-eu-posso-modificar-as-configura%C3%A7%C3%B5es-do-meu-prometheus">Como eu posso modificar as configurações do meu Prometheus?</a>
<ul>
<li><a href="#definindo-o-nosso-prometheus">Definindo o nosso Prometheus</a></li>
<li><a href="#definindo-o-nosso-alertmanager">Definindo o nosso Alertmanager</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</details>
<h4 id="vamos-brincar-com-as-métricas-do-kubernetes"><a class="header" href="#vamos-brincar-com-as-métricas-do-kubernetes">Vamos brincar com as métricas do Kubernetes</a></h4>
<p>Muito bem, chegamos naquele momento que não precisaremos instalar mais nada, pelo menos por agora, pois já temos o nosso cluster Kubernetes com o Kube-Prometheus instalado.</p>
<p>O que vamos fazer agora é usufruir de todo o conhecimento já adquirido e também por todo o trabalho que já fizemos até esse momento.</p>
<p>Então agora é a hora de começar a brincar com as métricas e assim extrair informações sobre a saúde e performance do nosso cluster Kubernetes.</p>
<h5 id="o-que-podemos-saber-sobre-os-nodes-do-nosso-cluster"><a class="header" href="#o-que-podemos-saber-sobre-os-nodes-do-nosso-cluster">O que podemos saber sobre os nodes do nosso cluster?</a></h5>
<p>Algumas métricas que podemos extrair sobre os nodes do nosso cluster são:</p>
<ul>
<li>Quantos nós temos no nosso cluster?</li>
<li>Qual a quantidade de CPU e memória que cada nó tem?</li>
<li>O nó está disponível para receber novos pods?</li>
<li>Qual a quantidade de informação que cada nó está recebendo e enviando?</li>
<li>Quantos pods estão rodando em cada nó?</li>
</ul>
<p>Vamos responder essas quatro perguntas utilizando o PromQL e as métricas que estamos coletando do nosso cluster Kubernetes.</p>
<h6 id="quantos-nós-temos-no-nosso-cluster"><a class="header" href="#quantos-nós-temos-no-nosso-cluster">Quantos nós temos no nosso cluster?</a></h6>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_node_info</code> que nos mostra informações sobre os nós do nosso cluster. Podemos utilizar a função <code>count</code> para contar quantas vezes a métrica <code>kube_node_info</code> aparece no nosso cluster.</p>
<pre><code class="language-promql">count(kube_node_info)
</code></pre>
<p>No nosso cluster, temos 2  nós, então a resposta para essa pergunta é 2.</p>
<h6 id="qual-a-quantidade-de-cpu-e-memória-que-cada-nó-tem"><a class="header" href="#qual-a-quantidade-de-cpu-e-memória-que-cada-nó-tem">Qual a quantidade de CPU e memória que cada nó tem?</a></h6>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_node_status_allocatable</code> que nos mostra a quantidade de CPU e memória que cada nó tem disponível para ser utilizado.</p>
<pre><code class="language-promql">kube_node_status_allocatable
</code></pre>
<p>Aqui ele vai te trazer todas as informações sobre CPU, memória, pods, etc. Mas nós só queremos saber sobre CPU e memória, então vamos filtrar a nossa consulta para trazer apenas essas informações.</p>
<pre><code class="language-promql">kube_node_status_allocatable{resource=&quot;cpu&quot;}
kube_node_status_allocatable{resource=&quot;memory&quot;}
</code></pre>
<p>Fácil, agora precisamos somente de um pouco de matemática para converter os valores referente a memória para gigabytes.</p>
<pre><code class="language-promql">kube_node_status_allocatable{resource=&quot;memory&quot;} / 1024 / 1024 / 1024
</code></pre>
<p>Pronto, agora ficou um pouco mais fácil de ler a quantidade de memória que temos em cada nó.</p>
<h6 id="o-nó-está-disponível-para-receber-novos-pods"><a class="header" href="#o-nó-está-disponível-para-receber-novos-pods">O nó está disponível para receber novos pods?</a></h6>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_node_status_condition</code> que nos mostra o status de cada nó do nosso cluster.</p>
<pre><code class="language-promql">kube_node_status_condition{condition=&quot;Ready&quot;, status=&quot;true&quot;}
</code></pre>
<p>Com a consulta acima, estamos perguntando para métrica <code>kube_node_status_condition</code> se o nó está pronto para receber novos pods. Se o nó estiver pronto, ele vai retornar o valor 1, caso contrário, ele vai retornar o valor 0.</p>
<p>Isso porque estamos perguntando para a métrica <code>kube_node_status_condition</code> se o nó está com a condição <code>Ready</code> e se o status dessa condição é <code>true</code>, se mudassemos o status para <code>false</code>, ele iria retornar o valor 0. Simplão demais!</p>
<h6 id="qual-a-quantidade-de-informação-que-cada-nó-está-recebendo-e-enviando"><a class="header" href="#qual-a-quantidade-de-informação-que-cada-nó-está-recebendo-e-enviando">Qual a quantidade de informação que cada nó está recebendo e enviando?</a></h6>
<p>Aqui vamos levar em consideração que estamos falando de trafego de rede, o quanto o nosso nó está recebendo e enviando de dados pela rede.</p>
<p>Para isso vamos utilizar a métrica <code>node_network_receive_bytes_total</code> e <code>node_network_transmit_bytes_total</code> que nos mostra a quantidade de bytes que o nó está recebendo e enviando.</p>
<pre><code class="language-promql">node_network_receive_bytes_total
node_network_transmit_bytes_total
</code></pre>
<p>Perceba que a saída dessa consulta ela traz a quantidade de bytes por pod, mas nós queremos saber a quantidade de bytes por nó, então vamos utilizar a função <code>sum</code> para somar a quantidade de bytes que cada pod está recebendo e enviando.</p>
<pre><code class="language-promql">sum by (instance) (node_network_receive_bytes_total)
sum by (instance) (node_network_transmit_bytes_total)
</code></pre>
<p>Pronto, dessa forma teriamos a quantidade de bytes que cada nó está recebendo e enviando. No meu caso, como somente tenho dois nodes, o resultado foram duas linhas, uma para cada nó, mostrando a quantidade de bytes que cada nó está recebendo e enviando.</p>
<p>Agora vamos converter esses bytes para megabytes, para ficar mais fácil de ler.</p>
<pre><code class="language-promql">sum by (instance) (node_network_receive_bytes_total) / 1024 / 1024
sum by (instance) (node_network_transmit_bytes_total) / 1024 / 1024
</code></pre>
<p>Vamos para a próxima pergunta.</p>
<h5 id="quantos-pods-estão-rodando-em-cada-nó"><a class="header" href="#quantos-pods-estão-rodando-em-cada-nó">Quantos pods estão rodando em cada nó?</a></h5>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_pod_info</code> que nos mostra informações sobre os pods que estão rodando no nosso cluster.</p>
<pre><code class="language-promql">kube_pod_info
</code></pre>
<p>Caso eu queria saber o número de pods que estão rodando em cada nó, eu poderia utilizar a função <code>count</code> para contar quantas vezes a métrica <code>kube_pod_info</code> aparece em cada nó.</p>
<pre><code class="language-promql">count by (node) (kube_pod_info)
</code></pre>
<p>Pronto, agora eu sei quantos pods estão rodando em cada nó. No meu caso o meu cluster está bem sussa, somente 9 pods em um nó e 10 no outro, um dia de alegriaaaaa!</p>
<h4 id="agora-vamos-saber-se-o-nosso-cluster-está-com-problemas"><a class="header" href="#agora-vamos-saber-se-o-nosso-cluster-está-com-problemas">Agora vamos saber se o nosso cluster está com problemas</a></h4>
<p>Agora que já sabemos como extrair informações sobre a saúde e performance do nosso cluster Kubernetes, vamos aprender como podemos ser notificados caso o nosso cluster esteja com algum problema.</p>
<h5 id="o-que-podemos-saber-sobre-os-pods-do-nosso-cluster"><a class="header" href="#o-que-podemos-saber-sobre-os-pods-do-nosso-cluster">O que podemos saber sobre os pods do nosso cluster?</a></h5>
<p>Algumas métricas que podemos extrair sobre os pods do nosso cluster são:</p>
<ul>
<li>Quantos pods estão rodando no nosso cluster?</li>
<li>Quantos pods estão com problemas?</li>
<li>Verificar os pods e os limites de memória e CPU configurados</li>
<li>Verificar se o cluster está com problemas de espaço em disco</li>
<li>Verificar se o cluster está com problemas de consumo de memória</li>
</ul>
<h6 id="quantos-pods-estão-rodando-no-nosso-cluster"><a class="header" href="#quantos-pods-estão-rodando-no-nosso-cluster">Quantos pods estão rodando no nosso cluster?</a></h6>
<p>Essa é fácil e já sabemos qual a métrica que vai nos ajudar a responder essa pergunta.</p>
<pre><code class="language-promql">count(kube_pod_info)
</code></pre>
<p>Simples assim.</p>
<h6 id="quantos-pods-estão-com-problemas"><a class="header" href="#quantos-pods-estão-com-problemas">Quantos pods estão com problemas?</a></h6>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_pod_status_phase</code> que nos mostra o status de cada pod do nosso cluster.</p>
<pre><code class="language-promql">kube_pod_status_phase
</code></pre>
<p>Essa métrica irá nos mostrar o status de cada pod, se o pod está rodando, se ele está em erro, se ele está em execução, etc. Mas nós só queremos saber se o pod está em erro, então vamos filtrar a nossa consulta para trazer apenas os pods que estão em erro.</p>
<pre><code class="language-promql">kube_pod_status_phase{phase=&quot;Failed&quot;}
</code></pre>
<p>E se eu quiser saber o número de pods que estão em erro?</p>
<pre><code class="language-promql">count(kube_pod_status_phase{phase=&quot;Failed&quot;})
</code></pre>
<p>Vamos melhorar, eu quero saber o número de pods que estão em erro por namespace.</p>
<pre><code class="language-promql">count by (namespace) (kube_pod_status_phase{phase=&quot;Failed&quot;})
</code></pre>
<p>Ou ainda por nó.</p>
<pre><code class="language-promql">count by (node) (kube_pod_status_phase{phase=&quot;Failed&quot;})
</code></pre>
<p>Simples assim.</p>
<p>Os status que podemos utilizar são:</p>
<ul>
<li><code>Pending</code>: Pod está aguardando para ser executado</li>
<li><code>Running</code>: Pod está sendo executado</li>
<li><code>Succeeded</code>: Pod foi executado com sucesso</li>
<li><code>Unknown</code>: Pod está em um estado desconhecido</li>
<li><code>Failed</code>: Pod foi executado e falhou</li>
</ul>
<p>Agora é só escolher o que você quer saber e sair testando.</p>
<h6 id="verificar-os-pods-e-os-limites-de-memória-e-cpu-configurados"><a class="header" href="#verificar-os-pods-e-os-limites-de-memória-e-cpu-configurados">Verificar os pods e os limites de memória e CPU configurados</a></h6>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_pod_container_resource_limits</code> que nos mostra os limites de memória e CPU que cada pod está utilizando.</p>
<pre><code class="language-promql">kube_pod_container_resource_limits
</code></pre>
<p>Agora vamos filtrar a nossa consulta para trazer apenas os pods e os limites de memória e CPU configurados.</p>
<pre><code class="language-promql">kube_pod_container_resource_limits{resource=&quot;memory&quot;}
kube_pod_container_resource_limits{resource=&quot;cpu&quot;}
</code></pre>
<p>Assim você consegue saber quais os limites de memória e CPU que cada pod está utilizando.</p>
<h6 id="verificar-se-o-cluster-está-com-problemas-relacionados-ao-disco"><a class="header" href="#verificar-se-o-cluster-está-com-problemas-relacionados-ao-disco">Verificar se o cluster está com problemas relacionados ao disco</a></h6>
<p>Tem um status de node que é o <code>DiskPressure</code>, que significa que o nó está com problemas relacionados ao disco. Para saber se o nó está com esse status, vamos utilizar a métrica <code>kube_node_status_condition</code> que nos mostra o status de cada nó.</p>
<pre><code class="language-promql">kube_node_status_condition{condition=&quot;DiskPressure&quot;, status=&quot;true&quot;}
</code></pre>
<p>Se o valor retornado for 1, significa que o nó está com problemas relacionados ao disco, agora, se o valor for 0, significa que o nó está ok e você não precisa se preocupar.</p>
<h6 id="verificar-se-o-cluster-está-com-problemas-relacionados-a-memória"><a class="header" href="#verificar-se-o-cluster-está-com-problemas-relacionados-a-memória">Verificar se o cluster está com problemas relacionados a memória</a></h6>
<p>Tem um status de node que é o <code>MemoryPressure</code>, que significa que o nó está com problemas relacionados a memória. Para saber se o nó está com esse status, vamos utilizar a métrica <code>kube_node_status_condition</code> que nos mostra o status de cada nó.</p>
<pre><code class="language-promql">kube_node_status_condition{condition=&quot;MemoryPressure&quot;, status=&quot;true&quot;}
</code></pre>
<p>Se o valor retornado for 1, se prepare, pois você vai precisar entender o que está pegando com o seu nó, ou seja, terá um dia de trabalho pela frente. :D</p>
<h4 id="e-como-saber-se-meus-deployments-estão-com-problemas"><a class="header" href="#e-como-saber-se-meus-deployments-estão-com-problemas">E como saber se meus deployments estão com problemas?</a></h4>
<p>Algumas perguntas que podemos responder sobre os deployments do nosso cluster são:</p>
<ul>
<li>Quantos deployments estão rodando no meu cluster?</li>
<li>Quantos deployments estão com problemas?</li>
<li>Qual o status dos meus deployments?</li>
</ul>
<h6 id="quantos-deployments-estão-rodando-no-meu-cluster"><a class="header" href="#quantos-deployments-estão-rodando-no-meu-cluster">Quantos deployments estão rodando no meu cluster?</a></h6>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_deployment_status_replicas</code> que nos mostra o número de replicas que cada deployment está rodando.</p>
<pre><code class="language-promql">kube_deployment_status_replicas
</code></pre>
<p>Assim ele traz a lista de todos os deployments e o número de replicas que cada um está rodando.</p>
<h6 id="quantos-deployments-estão-com-problemas"><a class="header" href="#quantos-deployments-estão-com-problemas">Quantos deployments estão com problemas?</a></h6>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_deployment_status_replicas_unavailable</code> que nos mostra o número de replicas indisponíveis que cada deployment está rodando.</p>
<pre><code class="language-promql">kube_deployment_status_replicas_unavailable
</code></pre>
<p>Se tudo estiver bem, o valor retornado será 0, caso contrário, o valor retornado será o número de replicas indisponíveis.</p>
<h6 id="qual-o-status-dos-meus-deployments"><a class="header" href="#qual-o-status-dos-meus-deployments">Qual o status dos meus deployments?</a></h6>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_deployment_status_condition</code> que nos mostra o status de cada deployment.</p>
<pre><code class="language-promql">kube_deployment_status_condition
</code></pre>
<p>Com a consulta acima, você consegue saber o status de cada deployment, se ele está ok, se ele está com problemas, etc.</p>
<p>Se quisermos saber a lista de deployments com problemas, podemos utilizar a seguinte consulta.</p>
<pre><code class="language-promql">kube_deployment_status_condition{condition=&quot;Available&quot;, status=&quot;false&quot;}
</code></pre>
<p>Assim, se o valor retornado for 1, significa que o deployment está com problemas, caso contrário, significa que o deployment está ok.</p>
<h4 id="e-como-saber-se-meus-serviços-estão-com-problemas"><a class="header" href="#e-como-saber-se-meus-serviços-estão-com-problemas">E como saber se meus serviços estão com problemas?</a></h4>
<p>Algumas perguntas que podemos responder sobre os serviços do nosso cluster são:</p>
<ul>
<li>Quantos serviços estão rodando no meu cluster?</li>
<li>Todos os meus serviços estão com endpoints?</li>
<li>Todos os meus serviços estão com endpoints ativos?</li>
</ul>
<p>Vamos responder cada uma delas.</p>
<h6 id="quantos-serviços-estão-rodando-no-meu-cluster"><a class="header" href="#quantos-serviços-estão-rodando-no-meu-cluster">Quantos serviços estão rodando no meu cluster?</a></h6>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_service_info</code> que nos mostra o número de serviços que estão rodando no nosso cluster.</p>
<pre><code class="language-promql">kube_service_info
</code></pre>
<p>Assim ele traz a lista de todos os serviços que estão rodando no nosso cluster, com o valor 1.</p>
<h6 id="todos-os-meus-serviços-estão-com-endpoints"><a class="header" href="#todos-os-meus-serviços-estão-com-endpoints">Todos os meus serviços estão com endpoints?</a></h6>
<p>Para responder essa pergunta, vamos utilizar a métrica <code>kube_endpoint_address</code> que nos traz a lista de endpoints de cada serviço.</p>
<pre><code class="language-promql">kube_endpoint_address
</code></pre>
<p>Agora para saber os endpoints para um determinado serviço, vamos utilizar a seguinte consulta.</p>
<pre><code class="language-promql">kube_endpoint_address{endpoint=&quot;kube-dns&quot;}
</code></pre>
<h6 id="todos-os-meus-serviços-estão-com-endpoints-ativos"><a class="header" href="#todos-os-meus-serviços-estão-com-endpoints-ativos">Todos os meus serviços estão com endpoints ativos?</a></h6>
<p>Podemos ainda buscar por endpoints com o status <code>ready</code> igual a <code>false</code>, o que significa que o endpoint não está ativo.</p>
<pre><code class="language-promql">kube_endpoint_address{ready=&quot;false&quot;}
</code></pre>
<p>Se a lista for vazia, significa que todos os endpoints estão ativos!</p>
<p>Acho que já deu para brincar um pouco sobre as nossas métricas que estão vindo do Kubernetes! :D</p>
<p>Vamos brincar com algo novo agora!</p>
<h4 id="como-eu-posso-modificar-as-configurações-do-meu-prometheus"><a class="header" href="#como-eu-posso-modificar-as-configurações-do-meu-prometheus">Como eu posso modificar as configurações do meu Prometheus?</a></h4>
<p>Quando fizemos a instalação do nosso kube-prometheus, nós criamos alguns Custom Resource Definitions (CRDs) em nosso cluster. Nós já vimos alguns deles como o <code>ServiceMonitor</code> e o <code>PrometheusRule</code>, porém o nosso foco agora será em dois outros CRDs que são o <code>Prometheus</code> e o <code>Alertmanager</code>.</p>
<p>O <code>Prometheus</code> é o nosso recurso que vai nos permitir configurar o Prometheus que está rodando em nosso cluster. Já o <code>Alertmanager</code> é o nosso recurso que vai nos permitir configurar o Alertmanager.</p>
<p>Vamos focar nessa primeira parte no <code>Prometheus</code>.</p>
<h5 id="definindo-o-nosso-prometheus"><a class="header" href="#definindo-o-nosso-prometheus">Definindo o nosso Prometheus</a></h5>
<p>Como eu disse, o recurso <code>Prometheus</code> é o nosso recurso que vai nos permitir configurar o Prometheus, e assim customiza-lo para as nossas necessidades.</p>
<p>Esse arquivo é o arquivo que vem por padrão quando instalamos o kube-prometheus, ele fica dentro do diretório <code>manifests/</code> do nosso repositório do kube-prometheus e ele se chama <code>prometheus-prometheus.yaml</code>.</p>
<pre><code class="language-yaml">apiVersion: monitoring.coreos.com/v1 # Versão da API
kind: Prometheus # Tipo do recurso, no caso, Prometheus
metadata: # Informações sobre o recurso
  labels: # Labels que serão adicionadas ao nosso Prometheus
    app.kubernetes.io/component: prometheus # Label que indica que o recurso é um Prometheus
    app.kubernetes.io/instance: k8s # Label que indica que o recurso é o Prometheus do nosso cluster
    app.kubernetes.io/name: prometheus # Label que indica que o recurso é um Prometheus
    app.kubernetes.io/part-of: kube-prometheus # Label que indica que o recurso é parte do kube-prometheus
    app.kubernetes.io/version: 2.42.0 # Label que indica a versão do Prometheus
  name: k8s # Nome do nosso Prometheus
  namespace: monitoring # Namespace onde o Prometheus vai ser criado
spec: # Especificações do nosso Prometheus
  alerting: # Configurações de alerta 
    alertmanagers: # Lista de alertmanagers que o Prometheus vai utilizar
    - apiVersion: v2 # Versão da API do Alertmanager
      name: alertmanager-main # Nome do Alertmanager
      namespace: monitoring # Namespace onde o Alertmanager está rodando
      port: web # Porta que o Alertmanager está rodando
  enableFeatures: [] # Lista de features que serão habilitadas no Prometheus, no caso, nenhuma
  externalLabels: {} # Labels que serão adicionadas a todas as métricas que o Prometheus coletar
  image: quay.io/prometheus/prometheus:v2.42.0 # Imagem do Prometheus
  nodeSelector: # Node selector que será utilizado para definir em qual node o Prometheus vai rodar
    kubernetes.io/os: linux # Node selector que indica que o Prometheus vai rodar em nodes com o sistema operacional Linux
  podMetadata: # Metadata que será adicionada aos pods do Prometheus
    labels: # Labels que serão adicionadas aos pods do Prometheus
      app.kubernetes.io/component: prometheus # Label que indica que o pod é um Prometheus
      app.kubernetes.io/instance: k8s # Label que indica que o pod é o Prometheus do nosso cluster
      app.kubernetes.io/name: prometheus # Label que indica que o pod é um Prometheus
      app.kubernetes.io/part-of: kube-prometheus # Label que indica que o pod é parte do kube-prometheus
      app.kubernetes.io/version: 2.42.0 # Label que indica a versão do Prometheus
  podMonitorNamespaceSelector: {} # Namespace selector que será utilizado para selecionar os pods que serão monitorados pelo Prometheus
  podMonitorSelector: {} # Selector que será utilizado para selecionar os pods que serão monitorados pelo Prometheus
  probeNamespaceSelector: {} # Namespace selector que será utilizado para selecionar os pods que serão monitorados pelo Prometheus
  probeSelector: {} # Selector que será utilizado para selecionar os pods que serão monitorados pelo Prometheus
  replicas: 2 # Número de réplicas que o Prometheus vai ter
  resources: # Recursos que serão utilizados pelo Prometheus
    requests: # Recursos mínimos que serão utilizados pelo Prometheus
      memory: 400Mi # Memória mínima que será utilizada pelo Prometheus
  ruleNamespaceSelector: {} # Namespace selector que será utilizado para selecionar as regras que serão utilizadas pelo Prometheus
  ruleSelector: {} # Selector que será utilizado para selecionar as regras que serão utilizadas pelo Prometheus
  securityContext: # Security context que será utilizado pelo Prometheus
    fsGroup: 2000 # ID do grupo que será utilizado pelo Prometheus
    runAsNonRoot: true # Indica que o Prometheus vai rodar como um usuário não root
    runAsUser: 1000 # ID do usuário que será utilizado pelo Prometheus
  serviceAccountName: prometheus-k8s # Nome da service account que será utilizada pelo Prometheus
  serviceMonitorNamespaceSelector: {} # Namespace selector que será utilizado para selecionar os serviços que serão monitorados pelo Prometheus
  serviceMonitorSelector: {} # Selector que será utilizado para selecionar os serviços que serão monitorados pelo Prometheus
  version: 2.42.0 # Versão do Prometheus
</code></pre>
<p>Esse arquivo é o arquivo que vem por padrão quando instalamos o kube-prometheus, ele fica dentro do diretório <code>manifests/</code> do nosso repositório do kube-prometheus.</p>
<p>No arquivo acima, eu já adicionei comentários para explicar o que cada parte do arquivo faz, espero que tenha ajudado no entendimento.</p>
<p>Caso você queira fazer alguma alteração no Prometheus que já está rodando, basta alterar esse arquivo e aplicar as alterações no cluster.</p>
<p>Vamos imaginar que você queira adicionar limites de utilização de memória e CPU no Prometheus, para isso, basta adicionar as seguintes linhas no arquivo.</p>
<pre><code class="language-yaml">  resources: # Recursos que serão utilizados pelo Prometheus
    requests: # Recursos mínimos que serão utilizados pelo Prometheus
      memory: 400Mi # Memória mínima que será utilizada pelo Prometheus
      cpu: 500m # CPU mínima que será utilizada pelo Prometheus
    limits: # Recursos máximos que serão utilizados pelo Prometheus
      memory: 1Gi # Memória máxima que será utilizada pelo Prometheus
      cpu: 900m # CPU máxima que será utilizada pelo Prometheus
</code></pre>
<p>Preste atenção para adicionar esse conteúdo dentro do bloco <code>spec:</code> e com a mesma indentação.</p>
<p>Agora, vamos aplicar as alterações no cluster.</p>
<pre><code class="language-bash">$ kubectl apply -f prometheus.yaml
</code></pre>
<p>Agora, vamos verificar se o Prometheus foi atualizado.</p>
<pre><code class="language-bash">$ kubectl get pods -n monitoring prometheus-k8s-0 -o yaml | grep -A 10 resources:
  resources:
    limits:
      cpu: 900m
      memory: 1Gi
    requests:
      cpu: 500m
      memory: 400Mi
</code></pre>
<p>Como podemos ver, o Prometheus foi atualizado com os novos recursos.</p>
<p>Tem diversas outras configurações que podemos fazer no Prometheus, como por exemplo, adicionar regras para alertas, selectors para selecionar os pods que serão monitorados, etc.</p>
<p>Mas eu sugiro que você comece a testar e achar a melhor configuração para a sua necessidade. Mas lembre-se sempre, você precisa testar, você precisa explorar, você precisa aprender! Bora pra cima! </p>
<h5 id="definindo-o-nosso-alertmanager"><a class="header" href="#definindo-o-nosso-alertmanager">Definindo o nosso Alertmanager</a></h5>
<p>Da mesma forma como fizemos com o Prometheus, vamos conhecer o arquivo responsável por definir o nosso Alertmanager.</p>
<p>O arquivo abaixo é o arquivo que vem por padrão quando instalamos o kube-prometheus, ele fica dentro do diretório <code>manifests/</code> do nosso repositório do kube-prometheus, o nome dele é <code>alertmanager-alertmanager.yaml</code>.</p>
<pre><code class="language-yaml">
```yaml
apiVersion: monitoring.coreos.com/v1 # Versão da API do Alertmanager
kind: Alertmanager # Tipo do objeto que estamos criando
metadata: # Metadata do objeto que estamos criando
  labels: # Labels que serão adicionadas ao objeto que estamos criando
    app.kubernetes.io/component: alert-router # Label que indica que o objeto é um Alertmanager
    app.kubernetes.io/instance: main # Label que indica que o objeto é o Alertmanager principal
    app.kubernetes.io/name: alertmanager # Label que indica que o objeto é um Alertmanager
    app.kubernetes.io/part-of: kube-prometheus # Label que indica que o objeto é parte do kube-prometheus
    app.kubernetes.io/version: 0.25.0 # Label que indica a versão do Alertmanager
  name: main # Nome do objeto que estamos criando
  namespace: monitoring # Namespace onde o objeto que estamos criando será criado
spec: # Especificações do objeto que estamos criando
  image: quay.io/prometheus/alertmanager:v0.25.0 # Imagem que será utilizada pelo Alertmanager
  nodeSelector: # Selector que será utilizado para selecionar os nós que o Alertmanager vai rodar
    kubernetes.io/os: linux # Selector que indica que o Alertmanager vai rodar em nós Linux
  podMetadata: # Metadata que será adicionada aos pods do Alertmanager
    labels: # Labels que serão adicionadas aos pods do Alertmanager
      app.kubernetes.io/component: alert-router # Label que indica que o pod é um Alertmanager
      app.kubernetes.io/instance: main # Label que indica que o pod é o Alertmanager principal
      app.kubernetes.io/name: alertmanager # Label que indica que o pod é um Alertmanager
      app.kubernetes.io/part-of: kube-prometheus # Label que indica que o pod é parte do kube-prometheus
      app.kubernetes.io/version: 0.25.0 # Label que indica a versão do Alertmanager
  replicas: 3 # Número de réplicas que o Alertmanager vai ter
  resources: # Recursos que serão utilizados pelo Alertmanager
    limits: # Recursos máximos que serão utilizados pelo Alertmanager
      cpu: 100m # CPU máxima que será utilizada pelo Alertmanager
      memory: 100Mi # Memória máxima que será utilizada pelo Alertmanager
    requests: # Recursos mínimos que serão utilizados pelo Alertmanager
      cpu: 4m # CPU mínima que será utilizada pelo Alertmanager
      memory: 100Mi # Memória mínima que será utilizada pelo Alertmanager
  securityContext: # Security context que será utilizado pelo Alertmanager
    fsGroup: 2000 # ID do grupo que será utilizado pelo Alertmanager
    runAsNonRoot: true # Indica que o Alertmanager vai rodar como um usuário não root
    runAsUser: 1000 # ID do usuário que será utilizado pelo Alertmanager
  serviceAccountName: alertmanager-main # Nome da service account que será utilizada pelo Alertmanager
  version: 0.25.0 # Versão do Alertmanager
</code></pre>
<p>Adicionei também comentários para explicar o que cada parte do arquivo faz, assim fica fácil de você entender o que está acontecendo.
Sempre lembrando, veja sempre a documentação oficial para entender melhor o que cada configuração faz e todas as opções que você tem.</p>
<p>Caso você queira fazer alguma alteração no Alertmanager que já está rodando, basta alterar esse arquivo e aplicar as alterações no cluster com o comando abaixo.</p>
<pre><code class="language-bash">$ kubectl apply -f alertmanager-alertmanager.yaml
</code></pre>
<p>Pronto, seu Alertmanager foi atualizado com as novas configurações, caso você tenha feito alguma alteração. hahah :D</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../day-7/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../day-9/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../day-7/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../day-9/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>